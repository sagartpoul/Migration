/*
*	author : root
*	date : Wed Oct 07 17:35:52 IST 2015
*	Description : building CUSTREL
*/
DECLARE
--FIXED VARIABLES
	v_STAGE NUMBER := 0;
	v_STAGE_TITLE VARCHAR2(50) := 'CUSTREL INSERT';
	c_LOG_FILE_NAME VARCHAR2(30) := 'CUSTREL.txt';
	c_LOG_FILE_INSERT VARCHAR2(30) := 'CUSTREL_INSERT_LOG.txt';
	v_ExistCount NUMBER := 0;
	v_oFile UTL_FILE.FILE_TYPE;
	v_oFile_INSERT UTL_FILE.FILE_TYPE;
	c_REC SYS_REFCURSOR;
	rec_CONFIG CSV_CONFIG%ROWTYPE;
	v_BRCODE NUMBER(4,0);
-- COUNTER SPECIFIC
	v_SUCCESS_COUNT NUMBER(7,0) := 0;
	v_FAILURE_COUNT NUMBER(7,0) := 0;
	v_TOTAL_COUNT NUMBER(7,0) := 0;
--OBJECT DEPENDENT
	v_ACTNO VARCHAR2(13);
	v_IR_NO NUMBER(6, 0):=0;
	v_CUST_ID VARCHAR2(13);
	v_SR_NO NUMBER(2, 0):=0;
	v_CUSTREL_ENTRY_MISS_CNT NUMBER(7,0) := 0;	
	v_ACTNO_PREV   VARCHAR2(13):='#';
	v_AGENTACTNO VARCHAR2(7);
	V_BR_CODE NUMBER;
BEGIN
	v_oFile := UTL_FILE.FOPEN('CSV_OUTPUT_DIR',c_LOG_FILE_NAME,'a');
	UTL_FILE.PUTF(v_oFile,'-------CUSTREL INSERT : Start Time %s-------%\n',TO_CHAR(SYSTIMESTAMP, 'HH12:MI:SS.FF4 AM'));
	--STEP-1-START-GET BRANCH CODE
	v_STAGE  := 100;
	v_BRCODE := FUN_GET_ACTIVE_BRANCH_CODE();
	v_STAGE  := 200;
	SELECT * INTO rec_CONFIG FROM CSV_CONFIG;
	--WHERE BRCODE=v_BRCODE;
	--STEP-1-END-GET BRANCH CODE
	--STEP-2-START-DROP EXISTING TABLES
		v_STAGE  := 300;
	
	COMMIT;
	--STEP-2-END-DELETE-RECORDS FROM EXISTING TABLE
	--STEP-3-START-PROCESS CURSOR AND CALL THE INSERT SCRIPT
	v_oFile_INSERT := UTL_FILE.FOPEN('CSV_OUTPUT_DIR',c_LOG_FILE_INSERT,'w');
	UTL_FILE.PUTF(v_oFile_INSERT,'-------INSERT STARTED: Start Time %s-------%\n',TO_CHAR(SYSTIMESTAMP, 'HH12:MI:SS.FF4 AM'));
	
	FOR c_REC IN
	(
		SELECT B.BE_ACTNO, A.* FROM JACNTDETAIL A INNER JOIN ACNTMST B
		ON A.ACODE=B.ACODE WHERE B.OPTYPE='J'  ORDER BY A.ACODE,A.ENT_NO
	)
	LOOP
		  -- v_TOTAL_COUNT
			v_STAGE  := 400;
			v_TOTAL_COUNT := v_TOTAL_COUNT + 1;
			
		  -- Start of ACTNO
			v_STAGE  := 500;
			v_ACTNO:=c_REC.BE_ACTNO;			
		  -- End of ACTNO
			
		  -- Start of IR_NO
			v_STAGE  := 600;
			--v_IR_NO := NULL;
		  -- End of IR_NO
			
			v_STAGE  := 700;
			V_BR_CODE:=SUBSTR(v_ACTNO,1,4);
		 
		 -- Start of CUST_ID			
			v_STAGE  := 701;
			v_CUST_ID := NULL;
			
			BEGIN
				SELECT BE_CUST_ID INTO v_CUST_ID FROM CUSTMASTER WHERE CUST_ID=c_REC.CUST_ID;
			EXCEPTION
				WHEN OTHERS THEN
					v_CUST_ID := NULL;
			END;
		  -- End of CUST_ID
		
		 --START  OF SR_NO
			 v_STAGE  := 800;
			 IF ( v_ACTNO != v_ACTNO_PREV) THEN
				v_SR_NO :=2;
				v_IR_NO := 1;
				v_ACTNO_PREV :=v_ACTNO;
			 ELSE
				v_SR_NO:=v_SR_NO+1;
				v_IR_NO := v_IR_NO+1;
			 END IF;
		
		 --END OF SR_NO
	
	v_STAGE  := 900;
	BEGIN
		INSERT INTO CUSTREL VALUES 
		( 
			v_ACTNO, --ACTNO
			v_IR_NO, --IR_NO
			v_CUST_ID, --CUST_ID
			v_SR_NO, --SR_NO
			NULL -- REF_KEY1
		);			
	
	v_STAGE  := 1000;
	
	--v_SUCCESS_COUNT 
	v_SUCCESS_COUNT := v_SUCCESS_COUNT + 1;
	EXCEPTION
		WHEN OTHERS THEN
			v_FAILURE_COUNT := v_FAILURE_COUNT + 1;
	END;
	
	BEGIN
	
		INSERT INTO SIGNAUTH VALUES 
		( 
		v_ACTNO, --ACTNO
		v_IR_NO, --IR_NO
		v_SR_NO, --SR_NO
		TO_DATE('01/01/1981', 'DD/MM/YYYY'), --TRAN_DATE
		v_CUST_ID, --CUST_ID
		1, --CAPACITY
		NULL, --VALDATE
		NULL -- REF_KEY1
		);
	EXCEPTION
		WHEN OTHERS THEN
				UTL_FILE.PUTF(v_oFile_INSERT,'-ERROR IN SIGNAUTH INSERT STAGE##%s  ACTNO ::%s Error-%s-%s\n',v_STAGE,v_ACTNO,SQLCODE,SQLERRM);
			NULL;
	END;
	
	<<SKIP_RECORD>>
		NULL;
		COMMIT;
	END LOOP;
	
	COMMIT;
	
	UTL_FILE.PUTF(v_oFile_INSERT,'\n-------INSERT ENDED: End Time %s-------%\n',TO_CHAR(SYSTIMESTAMP, 'HH12:MI:SS.FF4 AM'));
	UTL_FILE.FCLOSE(v_oFile_INSERT);
	UTL_FILE.PUTF(v_oFile,'-------SUMMARY : \n');
	UTL_FILE.PUTF(v_oFile,'-NO. OF RECORD PROCESS TO CUSTREL=%s\n',v_TOTAL_COUNT);
	UTL_FILE.PUTF(v_oFile,'-NO. OF RECORDS ADDED TO CUSTREL=%s\n',v_SUCCESS_COUNT);
	UTL_FILE.PUTF(v_oFile, '-NO. OF v_CUSTREL_ENTRY_MISS_CNT %s\n', v_CUSTREL_ENTRY_MISS_CNT);
	UTL_FILE.PUTF(v_oFile,'-NO. OF FAILURES TO CUSTREL=%s\n',v_FAILURE_COUNT);
	UTL_FILE.PUTF(v_oFile,'-------ACCOUNT INSERT : End Time %s-------%\n',TO_CHAR(SYSTIMESTAMP, 'HH12:MI:SS.FF4 AM'));
	UTL_FILE.FCLOSE(v_oFile);
EXCEPTION
	WHEN OTHERS THEN
	ROLLBACK;
	UPDATE CSV_CONFIG SET PROCESS_STATUS = 'N' WHERE STATUS='L';
	COMMIT;
	DBMS_OUTPUT.PUT_LINE('???????UNRECOVERABLE ERROR : STAGE#' || v_STAGE || '-Error- ' || SQLCODE || '-' || SQLERRM );
	UTL_FILE.PUTF(v_oFile,'\n???????UNRECOVERABLE ERROR : STAGE#%s-Error-%s-%s, End Time %s-------%\n',v_STAGE,SQLCODE,SQLERRM,TO_CHAR(SYSTIMESTAMP, 'HH12:MI:SS.FF4 AM'));
	UTL_FILE.FCLOSE(v_oFile);
END;
/